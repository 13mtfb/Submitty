#!/bin/bash


# TEMPORARY LINE, REMOVE THIS

cp test_to_be_compiled.txt submissions/hw1/to_be_compiled.txt || echo "DEBUG PROBS"

# END TEMPORARY

assignment_submission_path="$1"
echo "Assignment submissions path set to $assignment_submission_path"
assignment_name="$(basename $assignment_submission_path)"
echo "Assignment name set to $assignment_name"

tmp="$2"
echo "Temporary directory set to $tmp"

results_path="$3"
echo "Results directory set to $results_path"

echo "Looking for to_be_compiled.txt in $1"

if [[ ! -f  "$assignment_submission_path/to_be_compiled.txt" ]]; then
	echo "Nothing to be compiled"
	exit
fi

echo "to_be_compiled.txt found"

while read path; do

	echo "Copying path ($assignment_submission_path/$path) to tmp directory ($tmp/submission)"

	cp -r "$assignment_submission_path/$path" "$tmp/submission" || echo "ERROR: Failed to copy to temporary directory"

	submission_no="$(basename $path)"
	submission_time="$(date -r $assignment_submission_path/$path "+%F %T")"

	# RUN RUNNER

	# RUN VALIDATOR

	# Make directory structure in results if it doesn't exist

	mkdir -p "$results_path/$assignment_name/$path" || echo "ERROR: Could not create results path"

	echo "Copying temporary directory ($tmp/submission) to results directory ($results_path/$assignment_name/$path)"

	cp -r "$tmp/submission" "$results_path/$path" || echo "ERROR: Could not copy temporary directory to results directory"

	echo "Removing temporary directory ($tmp/submission)"

	rm -r "$tmp/submission" || echo "ERROR: Failed to remove temporary directory"

done < "$1/to_be_compiled.txt"

rm "$1/to_be_compiled.txt"